select m.email, count(p.pid) as total_penalties, sum(case when p.paid_amount >= p.amount then 1 else 0 end) as penalties_paid, sum(case when p.paid_amount >= p.amount then p.amount else 0 end) as total_paid_amount from members m left join borrowings b on m.email = b.member left join penalties p on p.bid = b.bid group by m.email having total_penalties > 0 or total_penalties is null;
